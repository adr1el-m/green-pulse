<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Environmental Protection Quiz</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: "#2C5F2D",
                        secondary: "#97BC62FF",
                        accent: "#A7C957",
                        dark: "#1B3B1A",
                        light: "#E9F5DB",
                    }
                }
            }
        };
    </script>
</head>
<body class="bg-light text-dark dark:bg-dark dark:text-light transition-all">
    <div id="landingPage" class="min-h-screen flex flex-col items-center justify-center px-6">
        <div class="w-full max-w-2xl bg-white dark:bg-primary shadow-lg rounded-lg p-6">
            <h1 class="text-4xl font-bold text-center text-primary dark:text-light mb-4">Environmental Protection Quiz</h1>
            <p class="text-center text-gray-600 dark:text-gray-300 mb-6">
                Test your knowledge on environmental protection topics.
            </p>
            <form id="quizSetupForm" class="space-y-4">
                <div>
                    <label class="block text-lg font-semibold">Number of Questions</label>
                    <select id="numQuestions" class="w-full p-2 rounded bg-gray-100 dark:bg-gray-800 dark:text-light">
                        <option value="5">5</option>
                        <option value="10">10</option>
                        <option value="20">20</option>
                        <option value="50">50</option>
                    </select>
                </div>
                <div>
                    <label class="block text-lg font-semibold">Quiz Topic</label>
                    <select id="quizTopic" class="w-full p-2 rounded bg-gray-100 dark:bg-gray-800 dark:text-light">
                        <option value="Climate Change">Climate Change</option>
                        <option value="Species Extinction">Species Extinction</option>
                        <option value="Pollution">Pollution</option>
                        <option value="Deforestation">Deforestation</option>
                        <option value="Sustainable Energy">Sustainable Energy</option>
                    </select>
                </div>
                <button type="submit" class="w-full bg-primary text-white py-2 rounded hover:bg-secondary transition">
                    Start Quiz
                </button>
            </form>
        </div>
    </div>

    <div id="quizPage" class="min-h-screen flex flex-col items-center justify-center px-6 hidden">
        <div class="w-full max-w-3xl bg-white dark:bg-primary shadow-lg rounded-lg p-6">
            <h2 id="quizTitle" class="text-3xl font-bold text-center text-primary dark:text-light mb-4">Your Quiz</h2>
            <div id="questionContainer" class="space-y-4">
                </div>
            <div id="feedback" class="mt-4 text-center"></div>
            <div class="mt-6 flex justify-between">
                <button id="prevButton" class="bg-secondary text-white py-2 px-4 rounded hover:bg-accent transition" disabled>Previous</button>
                <button id="submitButton" class="bg-primary text-white py-2 px-4 rounded hover:bg-secondary transition">Submit Answer</button>
                <button id="nextButton" class="bg-secondary text-white py-2 px-4 rounded hover:bg-accent transition" disabled>Next</button>
            </div>
            <button id="restartButton" class="mt-6 w-full bg-gray-500 text-white py-2 rounded hover:bg-gray-600 transition hidden">Restart Quiz</button>
        </div>
    </div>

  <script>
    // Replace with your valid Gemini API key
    const API_KEY = "AIzaSyDr-mS0aSHgcapEfJ5oNSaoiD4jyLqUZNA";

    const landingPage = document.getElementById("landingPage");
    const quizPage = document.getElementById("quizPage");
    const quizSetupForm = document.getElementById("quizSetupForm");
    const quizTitle = document.getElementById("quizTitle");
    const questionContainer = document.getElementById("questionContainer");
    const feedback = document.getElementById("feedback");
    const prevButton = document.getElementById("prevButton");
    const submitButton = document.getElementById("submitButton");
    const nextButton = document.getElementById("nextButton");
    const restartButton = document.getElementById("restartButton");

    // Global variables for quiz
    let quizQuestions = []; // Array to hold parsed quiz questions
    let currentQuestionIndex = 0;
    let userAnswers = []; // To track user answers

    // Function to format Gemini response (bold text and line breaks)
    function formatQuizResponse(text) {
      return text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
    }

    // Revised parseQuiz function using regex to extract quiz components
    function parseQuiz(text) {
    const questions = [];
    const regex = /Question\s*\d+:\s*(.*?)\s*A\)\s*(.*?)\s*B\)\s*(.*?)\s*C\)\s*(.*?)\s*D\)\s*(.*?)\s*Answer:\s*([A-D])/gs;
    let match;
    while ((match = regex.exec(text)) !== null) {
        const questionText = match[1].trim();
        const optionA = match[2].trim();
        const optionB = match[3].trim();
        const optionC = match[4].trim();
        const optionD = match[5].trim();
        const correctAnswer = match[6].trim().toUpperCase();
        questions.push({
            questionText,
            options: { A: optionA, B: optionB, C: optionC, D: optionD },
            correctAnswer
        });
    }
    return questions;
}


    // Function to display a single question
    function displayQuestion(index) {
      if (index < 0 || index >= quizQuestions.length) return;
      const q = quizQuestions[index];
      let html = `<p class="text-xl font-medium">${index + 1}. ${q.questionText}</p>`;
      html += `<div class="mt-4 grid grid-cols-1 gap-2">`;
      for (let key of ["A", "B", "C", "D"]) {
        html += `<button class="optionBtn w-full text-left p-2 border rounded hover:bg-gray-200 dark:hover:bg-gray-700 transition" data-option="${key}"><strong>${key})</strong> ${q.options[key]}</button>`;
      }
      html += `</div>`;
      questionContainer.innerHTML = html;
      feedback.innerHTML = "";
      if (userAnswers[index]) {
        const selectedOption = userAnswers[index];
        const btns = document.querySelectorAll(".optionBtn");
        btns.forEach(btn => {
          if (btn.getAttribute("data-option") === selectedOption) {
            btn.classList.add("bg-accent");
          } else {
            btn.classList.remove("bg-accent");
          }
        });
      }
      prevButton.disabled = index === 0;
      nextButton.disabled = true;
      submitButton.disabled = false;
    }

    // Handle option button click
    document.addEventListener("click", function(e) {
      if (e.target && e.target.matches(".optionBtn")) {
        document.querySelectorAll(".optionBtn").forEach(btn => btn.classList.remove("bg-accent"));
        e.target.classList.add("bg-accent");
        userAnswers[currentQuestionIndex] = e.target.getAttribute("data-option");
        submitButton.disabled = false;
      }
    });

    // Handle answer submission
    submitButton.onclick = () => {
      const selected = userAnswers[currentQuestionIndex];
      if (!selected) return;
      const correct = quizQuestions[currentQuestionIndex].correctAnswer;
      if (selected === correct) {
        feedback.innerHTML = `<p class="text-green-600">Correct!</p>`;
      } else {
        feedback.innerHTML = `<p class="text-red-600">Incorrect. The correct answer is <strong>${correct}</strong>.</p>`;
      }
      submitButton.disabled = true;
      if (currentQuestionIndex < quizQuestions.length - 1) {
        nextButton.disabled = false;
      } else {
        restartButton.classList.remove("hidden");
      }
    };

    // Navigation buttons
    nextButton.onclick = () => {
      if (currentQuestionIndex < quizQuestions.length - 1) {
        currentQuestionIndex++;
        displayQuestion(currentQuestionIndex);
      }
    };

    prevButton.onclick = () => {
      if (currentQuestionIndex > 0) {
        currentQuestionIndex--;
        displayQuestion(currentQuestionIndex);
      }
    };

    restartButton.onclick = () => {
      quizQuestions = [];
      userAnswers = [];
      currentQuestionIndex = 0;
      landingPage.classList.remove("hidden");
      quizPage.classList.add("hidden");
      restartButton.classList.add("hidden");
      questionContainer.innerHTML = "";
      feedback.innerHTML = "";
    };

    // Handle quiz setup form submission (generate quiz via Gemini)
    quizSetupForm.onsubmit = async (e) => {
      e.preventDefault();
      const numQuestions = document.getElementById("numQuestions").value;
      const quizTopic = document.getElementById("quizTopic").value;

      landingPage.classList.add("hidden");
      quizPage.classList.remove("hidden");
      questionContainer.innerHTML = `<p class="text-center text-gray-600 dark:text-gray-300">Generating your quiz...</p>`;
      quizTitle.innerText = `${quizTopic} Quiz`;

      const prompt = `Generate a quiz about **${quizTopic}** with **${numQuestions}** multiple choice questions. Each question must include four options labeled A, B, C, and D, and include an answer key in the following format:\n\nQuestion 1: [Question text]\nA) [Option A]\nB) [Option B]\nC) [Option C]\nD) [Option D]\nAnswer: [Correct letter]\n\nRepeat for all questions.`;
      
      try {
        const response = await fetch("https://generativelanguage.googleapis.com/v1/models/gemini-1.5-flash:generateContent?key=" + API_KEY, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            contents: [{ role: "user", parts: [{ text: prompt }] }]
          })
        });
        
        const data = await response.json();
        const responseText = data.candidates[0].content.parts[0].text;
        // Format and parse the quiz
        const formattedResponse = formatQuizResponse(responseText);
        quizQuestions = parseQuiz(formattedResponse);
        if (quizQuestions.length === 0) {
          questionContainer.innerHTML = `<p class="text-red-600 text-center">Failed to parse quiz questions. Please try again.</p>`;
          return;
        }
        currentQuestionIndex = 0;
        userAnswers = [];
        displayQuestion(currentQuestionIndex);
      } catch (error) {
        questionContainer.innerHTML = `<p class="text-red-600 text-center">‚ùå Error generating quiz. Please check your API key and network connection.</p>`;
      }
    };
  </script>
</body>
</html>
